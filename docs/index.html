<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Scheduled Events on Magic Online</title>
    <!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-8HF2HRS1RS"></script>
	<script>
  		window.dataLayer = window.dataLayer || [];
  		function gtag(){dataLayer.push(arguments);}
  		gtag('js', new Date());

  		gtag('config', 'G-8HF2HRS1RS');
	</script>
	<!-- jQuery library -->
	<script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>

	<!-- jQuery UI library -->
	<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<link rel="stylesheet" href="jquery_chosen/chosen.min.css">
	<link rel="stylesheet" type="text/css" href="style.css">
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.33/moment-timezone.min.js"></script>
  	<script src="jquery_chosen/chosen.jquery.min.js"></script>
  	<script src="auxiliaryScripts.js"></script>
  	<script src="color.js"></script>
  	<script src="schedule.js"></script>
  	<script src="util.js"></script>
  </head>
  <body>
  <div class="everything">
    <div>
	  	<header style="display: flex;">
	  		<div style="width: 100%; display: flex; align-content: center;">
	  			<div style="width: 5%;"></div>
	  			<div style="width: 4%;">
	  				<h4><span><br>Dark<br>mode</span></h4>
	  			</div>
	  			<div style="width: 6%;">
	  				<br>
	  				<h4><label class="switch">
	  						<input type="checkbox">
	  						<span class="slider round" id="darkModeSlider"></span>
						</label>
	  				</h4>
	  			</div>
	    		<div style="width: 20%;"></div>
	    		<div style="width: 30%;">
	      			<h1>Scheduled Events on MTGO</h1>
	    		</div>
	    		<div style="width: 5%;"></div>
	    		<div style="width: 30%"><br>
	    			<h4>Filter by:
	    			<select class="chosen-select" data-allow-single-deselect="true" data-placeholder="Format" id="formatDropdown"  style="width: 100px;" multiple>
		  				<option value="Limited">Limited</option>
		  				<option value="Standard">Standard</option>
		  				<option value="Pioneer">Pioneer</option>
		  				<option value="Modern">Modern</option>	
		  				<option value="Legacy">Legacy</option>
		  				<option value="Vintage">Vintage</option>
					</select>
				
					<select class="chosen-select" data-allow-single-deselect="true" data-placeholder="Event Type" id="eventTypeDropdown" multiple>
		  				<option value="Prelim">Prelim</option>
		  				<option value="Challenge">Challenge</option>
		  				<option value="Showcase Challenge">Showcase Challenge</option>
		  				<option value="Qualifier">Qualifier / Super Qualifier</option>
		  				<option value="LCQ">MOCS LCQ</option>
					</select>
					</h4>
				</div>
	  		</div>
		</header>
	  	<div class="contentWrapper">
		    <button id="info" class="infoButton"><div id="infoButtonText">&#8505;</div></button>
		    <div id="faq" class="modal">
		    	<div class="modal-content" id="modalContent">
		    		<span class="close">&times;</span>
		    		<p>
		    		<b>FAQ</b><br><br>
		    		<b>What is this website for?</b><br><br>
		    		It's hard to know when scheduled events are being held on MTGO. This site provides that information to you in your home time zone.<br><br>
		    		
		    		<b>My country and/or the United States are about to adjust the clocks by an hour for daylight saving time (AKA summer time).
		    		Are events taking place after the switch listed at the correct times?</b><br><br>
		    		
		    		Yes.<br><br>
		
					<b>What's your contact information?</b><br><br>
					
					Feel free to message me on Twitter @mtgoupdate or email me at admin at mtgoupdate dot com.<br><br>
					
					<b>You seem like a cool person and I've benefited from the work you've done. Will you please take my money?</b><br><br>
					
					Gladly. You can tip me at <a href="https://www.ko-fi.com/mtgoupdate">ko-fi.com/mtgoupdate</a> or contact me via Twitter or 
					email to discuss trading me MTGO tickets.<br><br>
					</p>
		    	</div>
		    </div>
			<div class="container">
			    <div id="day0"></div>
			    <div id="day1"></div>
			    <div id="day2"></div>
			    <div id="day3"></div>
			    <div id="day4"></div>
			    <div id="day5"></div>
			    <div id="day6"></div>
		    </div>
		    <div style="text-align: center;">
				<p>
				<strong>Detected local time: </strong><span id="localTime"></span><br>
				<strong>Displaying schedule for the week of </strong> <input type="text" id="datepicker">
				</p>
		    </div>
		</div>
	</div>
	<footer>
		<p style="text-align: center">Registering and maintaining this website isn't free. Any <a href="https://www.ko-fi.com/mtgoupdate">support</a> is appreciated.</p>
	</footer>
    </div>
  	<noscript><div>Please enable JavaScript</div></noscript>
  	
    <script>
    displaySchedule();
    
    function displaySchedule(fixColorModeSlider = true) {
        if (fixColorModeSlider) {
       		let checkbox = $('input[type="checkbox"]');
       		let color = getColorMode();
	    	if ((color === "dark") !== checkbox.prop("checked")) {
				checkbox.prop("checked", color === "dark");
			}
		}
    	let today, eventFilter;
    	[today, eventFilter] = initializePageAndParameters();
	    		
	    document.getElementById("localTime").innerHTML = today.toLocaleString([], {hour12: true, timeStyle: "medium"}) +
	    												" (" + Intl.DateTimeFormat().resolvedOptions().timeZone + ")";
	    				
		let PTOffset;
	    if (today.getTime() <= 1699178400000) {  // handles DST switch in November 2023
	    	PTOffset = 7;
	    } else {
	    	PTOffset = 8;
	    }
    
    	let hourOffset, minuteOffset;
    	[hourOffset, minuteOffset] = getHourAndMinuteOffset(PTOffset, today.getTimezoneOffset());
    	schedule = getNextWeekSchedule(today, hourOffset);
    	let heights = [-1, -1, -1, -1, -1, -1, -1]; // number of lines in each day so I can pad each textbox to be the same height
    	let fieldSets = generateFieldsetsForWeek(schedule, today, eventFilter, minuteOffset); // each day's textbox pre-padding
    	let max = 0;
	    for (let k = 0; k < 7; k++) {
	     	heights[k] = (fieldSets[k].match(/<br>/g) || []).length;
	     	if (heights[k] > max) {
	     		max = heights[k];
	     	}
	    }
	    for (let k = 0; k < 7; k++) {
	    	document.getElementById("day" + k).innerHTML = fieldSets[k] + "<br>".repeat(max - heights[k]) + "</fieldset>";
	    }
	}
    	
	function generateFieldsetsForWeek(schedule, today, eventFilter, minuteOffset) {
     	let isDarkMode = (document.querySelector("html").style.getPropertyValue("--bg-color")) !== "white";
     	
     	let ret = [null, null, null, null, null, null, null];
     	for (let i = 0; i < 7; i++) {
     		let textboxColor = getTextboxColor(today, isDarkMode);
     		let dayOfWeekTextColor = getDayOfWeekColor(today, isDarkMode);
     		let suffix = getSuffix(today.getDate());
     		
			ret[i] =
				`<fieldset style=\"border: 1px ${textboxColor} solid; display: inline-block; min-width: 280px;\">
     			<legend style=\"border: 1px ${textboxColor} solid;margin-left: 1em; border-radius: 15px; padding: 0.2em 0.8em \">
     			<span style=\"color: ${dayOfWeekTextColor}\"> ${today.toLocaleDateString("en-US", {weekday: "long"})} ${today.getDate()}${suffix}</span></legend>
     			${getScheduleForDay(today, schedule, eventFilter, i, minuteOffset, isDarkMode)}`;
     			
		   	today.setDate(today.getDate() + 1);
     	}
     	return ret;
	}
	
	// this is the next frontier for refactoring. look at all those parameters!
	function getScheduleForDay(today, schedule, eventFilter, dayCounter, minuteOffset, isDarkMode) {
		let ret = "";
		let upperLimit = (minuteOffset === 0) ? 24 : 23;
    	for (let j = 0; j <= upperLimit; j++) {
     		let k = 24 * dayCounter + j;
     		let events = (schedule[k]) ? schedule[k].split("&") : [null];
     		for (let index = 0; index < events.length; index++) {
     			let event = events[index];
     			if (event) {
     				if (event === "DST") {
     					
     				} else if (eventFilter(event)) {;
     					color = getEventColor(event, isDarkMode, j, k);
	     				ret += "<font color=" + color + ">" + getPrettyTime(j, minuteOffset) + " " + event + "</font><br>";
     				}
     			}
     		}
     	}
     	return ret;
	}
   </script>
   </body>
</html>